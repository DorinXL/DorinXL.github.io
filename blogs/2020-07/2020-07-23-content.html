<!DOCTYPE html>
<html lang="en">
<script src="https://cdn.jsdelivr.net/npm/texme@1.2.2"></script>
<meta name="referrer" content="no-referrer">
<head>
    <meta charset="UTF-8">
    <title>C语言的PELode编写记录</title>
</head>
<body>
<p>记录一下C语言写的简单的PE文件分析器。
</p><p>边学边做的，有些地方有疏漏了还请指点。
</p><p>我按照《逆向工程核心原理》这本书给出的大体结构对各部分内容进行输出，下面记录一下我遇到的难题和一些值得注意的点。
</p><p>
     </p><p><span style="font-size:16pt"><strong>一、
</strong></span></p><p>分析一个pe文件要做的第一件事就是把这个文件加载到内存中，也就是文件映射。
</p><p>这里我用的代码是：
</p><p>
     </p><ol><li><div style="background: white"><span style="color:seagreen; font-family:Consolas; font-size:9pt"><strong>char</strong><span style="color:black"> FilePath[] = <span style="color:blue">"E:\\test\\notepad.exe"<span style="color:black">;  <span style="color:#5c5c5c">
								</span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:seagreen; font-family:Consolas; font-size:9pt"><strong>HANDLE</strong><span style="color:black"> hFile = CreateFileA(FilePath, GENERIC_READ | GENERIC_WRITE, 0, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:seagreen; font-family:Consolas; font-size:9pt"><strong>HANDLE</strong><span style="color:black"> hMapping = CreateFileMapping(hFile, NULL, PAGE_READWRITE, 0, 0, NULL);  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:seagreen; font-family:Consolas; font-size:9pt"><strong>PVOID</strong><span style="color:black"> pbFile = MapViewOfFile(hMapping, FILE_MAP_ALL_ACCESS, 0, 0, 0);  <span style="color:#5c5c5c">
						</span></span></span></div></li></ol><p>
     </p><p>把FilePath[]内容改成需要分析的pe文件的路径即可。
</p><p>
     </p><p>然后我们准备分析一个文件的DOS头、NT头、输入表输出表，其他内容暂且不分析。
</p><p>一个DOS头的内容如下：
</p><p><img src="https://img2020.cnblogs.com/blog/1858293/202007/1858293-20200723184246634-1196235897.png" alt=""/>
</p><p>作为一个结构体，每个PE文件的DOS头长度不定，但是e_lfanew的值应该都是3cH。
</p><p>
     </p><p><span style="font-size:16pt"><strong>二、
</strong></span></p><p>如何找到并输出DOS头。
</p><p>在网络上搜集各种资料观察各种大牛的代码后我发现，当我把文件映射之后，可以直接定义DOS头的入口：
</p><p><img src="https://img2020.cnblogs.com/blog/1858293/202007/1858293-20200723184246944-518344621.png" alt=""/>
</p><p>这也让我对文件的本质和C语言编程多了一些理解，事实上这也是我第一次接触这种很像windows编程的小程序。
</p><p>直接用系统已经给出的结构体定义去声明一个DOS头，然后我们就可以以指针的形式去访问内部成员。
</p><p>
     </p><p>这里我又遇见了第三个问题，实际上这个问题应该是在映射文件前就该遇到了：
</p><p>
     </p><p>
     </p><p><span style="font-size:16pt"><strong>三、
</strong></span></p><p>刚开始的时候我并不明白这些DWORD、HANDLE都是些什么东西，查过资料后明白了，不过是和int、char这些东西一样，只是微软把他们typedef成了其他名称，本质还是一些基础的数据定义。
</p><p>搞清楚这个之后我们对于DOS头甚至是之后的整体文件就能有个大概的认识了。这些支离破碎的二进制被我们观测为十六进制，再加以联系组成一块一块的结构，最后一起拼接成了一个PE文件。
</p><p>
     </p><p>访问DOS头的成员：
</p><ol><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"==================================PE DOS HEADER==================================="<span style="color:black">);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"\ne_magic: 0x%04X"<span style="color:black">, pDosHeader-&gt;e_magic);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"\ne_cblp: 0x%04X"<span style="color:black">, pDosHeader-&gt;e_cblp);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"\ne_cp: 0x%04X"<span style="color:black">, pDosHeader-&gt;e_cp);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"\ne_crlc: 0x%04X"<span style="color:black">, pDosHeader-&gt;e_crlc);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"\ne_cparhdr: 0x%04X"<span style="color:black">, pDosHeader-&gt;e_cparhdr);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"\ne_minalloc: 0x%04X"<span style="color:black">, pDosHeader-&gt;e_minalloc);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"\ne_maxalloc: 0x%04X"<span style="color:black">, pDosHeader-&gt;e_maxalloc);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"\ne_ss: 0x%04X"<span style="color:black">, pDosHeader-&gt;e_ss);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"\ne_sp: 0x%04X"<span style="color:black">, pDosHeader-&gt;e_sp);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"\ne_csum: 0x%04X"<span style="color:black">, pDosHeader-&gt;e_csum);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"\ne_ip: 0x%04X"<span style="color:black">, pDosHeader-&gt;e_ip);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"\ne_cs: 0x%04X"<span style="color:black">, pDosHeader-&gt;e_cs);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"\ne_lfarlc: 0x%04X"<span style="color:black">, pDosHeader-&gt;e_lfarlc);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"\ne_ovno: 0x%04X\n"<span style="color:black">, pDosHeader-&gt;e_ovno);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>for</strong><span style="color:black"> (<span style="color:seagreen"><strong>int</strong><span style="color:black"> i = 0; i &lt;= 3; i++) {  <span style="color:#5c5c5c">
								</span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">   printf(<span style="color:blue">"e_res[%d]: 0x%04X   "<span style="color:black">,i, pDosHeader-&gt;e_res[i]);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">}  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"\ne_oemid: 0x%04X"<span style="color:black">, pDosHeader-&gt;e_oemid);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"\ne_oeminfo: 0x%04X\n"<span style="color:black">, pDosHeader-&gt;e_oeminfo);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>for</strong><span style="color:black"> (<span style="color:seagreen"><strong>int</strong><span style="color:black"> i = 0; i &lt;= 9; i++) {  <span style="color:#5c5c5c">
								</span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:#006699"><strong>if</strong><span style="color:black"> (!(i % 4) &amp;&amp; i) printf(<span style="color:blue">"\n"<span style="color:black">);  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    printf(<span style="color:blue">"e_res[%d]: 0x%04X   "<span style="color:black">, i, pDosHeader-&gt;e_res2[i]);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">}  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"\ne_lfanew: 0x%08X\n"<span style="color:black">, pDosHeader-&gt;e_lfanew);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8">  
     </div></li><li><div style="background: white"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">printf(<span style="color:blue">"\n==================================PE NT HEADER==================================="<span style="color:black">);<span style="color:#008200">//</span></span></span></span><span style="font-family:宋体">大小为</span><span style="color:#008200; font-family:Consolas">F8<span style="color:black">  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">PIMAGE_NT_HEADERS pNtHeader = (PIMAGE_NT_HEADERS32)((<span style="color:seagreen"><strong>DWORD</strong><span style="color:black">)pbFile + pDosHeader-&gt;e_lfanew);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"\nSignature: 0x%08X"<span style="color:black">, pNtHeader-&gt;Signature);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li></ol><p>
     </p><p>大部分以十六进制的方法输出，小部分需要看一下表示的内容于是便输出为%s或者是%d。
</p><p>
     </p><p>注意，在文件映射的开始我们定义了一个PVOID的pbFile，这个代表文件的入口，之后我们想要定位NT头或者其他什么内容时需要用到。
</p><p>
     </p><p>e_lfanew的值就是指从文件开头到NT头的距离，中间可能夹着DOS存根，但是无伤大雅，存根是只有在DOS环境下启动程序才会运行的内容，现在一般用来告诉用户这个软件应该在windows下打开。
</p><p>
     </p><p>把注意力放在NT头上：
</p><p><img src="https://img2020.cnblogs.com/blog/1858293/202007/1858293-20200723184247150-149759809.png" alt=""/>
</p><p>
     </p><p>通过强制类型转化可以找到NT头的起始位置，下面是NT头的内容:
</p><p><img src="https://img2020.cnblogs.com/blog/1858293/202007/1858293-20200723184247492-1934575057.png" alt=""/>
</p><p>
     </p><p>NT头看着没什么东西，里面其实包含了两个结构体，一个文件头一个可选头。
</p><p>NT头的第一个signature是签名，作为PE文件其值为0x50450000，也就是"PE"00
</p><ol><li><div style="background: white"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">printf(<span style="color:blue">"\n==================================PE NT HEADER==================================="<span style="color:black">);<span style="color:#008200">//</span></span></span></span><span style="font-family:宋体">大小为</span><span style="color:#008200; font-family:Consolas">F8<span style="color:black">  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">PIMAGE_NT_HEADERS pNtHeader = (PIMAGE_NT_HEADERS32)((<span style="color:seagreen"><strong>DWORD</strong><span style="color:black">)pbFile + pDosHeader-&gt;e_lfanew);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"\nSignature: 0x%08X"<span style="color:black">, pNtHeader-&gt;Signature);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li></ol><p>
     </p><p>
     </p><p>文件头的结构如下：
</p><p><img src="https://img2020.cnblogs.com/blog/1858293/202007/1858293-20200723184247824-1134713541.png" alt=""/>
</p><p>
     </p><ol><li><div style="background: white"><span style="color:#008200; font-size:9pt"><span style="font-family:Consolas">//NT</span><span style="font-family:宋体">头的</span><span style="font-family:Consolas">file header<span style="color:black">  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"\n==================================PE FILE HEADER===================================\n"<span style="color:black">);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"Machine: 0x%04X\n"<span style="color:black">, pNtHeader-&gt;FileHeader.Machine);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">printf(<span style="color:blue">"NumberOfSections: 0x%04X\n"<span style="color:black">, pNtHeader-&gt;FileHeader.NumberOfSections);           <span style="color:#008200">//</span></span></span></span><span style="font-family:宋体">文件中存在的节区数量</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"TimeDateStamp: 0x%08X\n"<span style="color:black">, pNtHeader-&gt;FileHeader.TimeDateStamp);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"PointerToSymbolTable: 0x%08X\n"<span style="color:black">, pNtHeader-&gt;FileHeader.PointerToSymbolTable);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"NumberOfSymbols: 0x%08X\n"<span style="color:black">, pNtHeader-&gt;FileHeader.NumberOfSymbols);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">printf(<span style="color:blue">"SizeOfOptionalHeader: 0x%04X\n"<span style="color:black">, pNtHeader-&gt;FileHeader.SizeOfOptionalHeader);   <span style="color:#008200">//</span></span></span></span><span style="font-family:宋体">指出</span><span style="color:#008200"><span style="font-family:Consolas">optional header </span><span style="font-family:宋体">的大小</span><span style="color:black; font-family:Consolas">  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">printf(<span style="color:blue">"Characteristics: 0x%04X\n"<span style="color:black">, pNtHeader-&gt;FileHeader.Characteristics);             <span style="color:#008200">//</span></span></span></span><span style="font-family:宋体">标识文件的属性</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li></ol><p>
     </p><p>
     </p><p>可选头结构如下：
</p><p>
     </p><p><img src="https://img2020.cnblogs.com/blog/1858293/202007/1858293-20200723184248968-55826475.png" alt=""/>
</p><p>
     </p><ol><li><div style="background: white"><span style="color:#008200; font-size:9pt"><span style="font-family:Consolas">//NT</span><span style="font-family:宋体">头的</span><span style="font-family:Consolas">optional header<span style="color:black">  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"\n===================================PE OPTIONAL HEADER====================================\n"<span style="color:black">);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white">  
     </div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"Machine:%04X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.Magic);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"MajorLinkerVersion:%02X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.MajorLinkerVersion);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"MinorLinkerVersion:%02X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.MinorLinkerVersion);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"SizeOfCode:%08X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.SizeOfCode);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"SizeOfInitializedData:%08X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.SizeOfInitializedData);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"SizeOfUninitializedData:%08X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.SizeOfUninitializedData);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">printf(<span style="color:blue">"AddressOfEntryPoint:%08X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.AddressOfEntryPoint);            <span style="color:#008200">//</span></span></span></span><span style="font-family:宋体">代码起始位置</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"BaseOfCode:%08X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.BaseOfCode);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"BaseOfData:%08X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.BaseOfData);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"ImageBase:%08X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.ImageBase);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"SectionAlignment:%08X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.SectionAlignment);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"FileAlignment:%08X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.FileAlignment);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"MajorOperatingSystemVersion:%04X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.MajorOperatingSystemVersion);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"MinorOperatingSystemVersion:%04X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.MinorOperatingSystemVersion);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"MajorImageVersion:%04X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.MajorImageVersion);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"MinorImageVersion:%04X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.MinorImageVersion);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"MajorSubsystemVersion:%04X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.MajorSubsystemVersion);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"MinorSubsystemVersion:%04X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.MinorSubsystemVersion);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"Win32VersionValue:%08X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.Win32VersionValue);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"SizeOfImage:%08X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.SizeOfImage);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">printf(<span style="color:blue">"SizeOfHeaders:%08X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.SizeOfHeaders);                        <span style="color:#008200">//</span></span></span></span><span style="font-family:宋体">整个</span><span style="color:#008200"><span style="font-family:Consolas">PE</span><span style="font-family:宋体">头大小</span><span style="color:black; font-family:Consolas">  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"CheckSum:%08X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.CheckSum);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"Subsystem:%04X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.Subsystem);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"DllCharacteristics:%04X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.DllCharacteristics);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"SizeOfStackReserve:%08X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.SizeOfStackReserve);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"SizeOfStackCommit:%08X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.SizeOfStackCommit);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"SizeOfHeapReserve:%08X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.SizeOfHeapReserve);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"SizeOfHeapCommit:%08X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.SizeOfHeapCommit);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"LoaderFlags:%08X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.LoaderFlags);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">printf(<span style="color:blue">"NumberOfRvaAndSizes:%08X\n"<span style="color:black">, pNtHeader-&gt;OptionalHeader.NumberOfRvaAndSizes);            <span style="color:#008200">//</span></span></span></span><span style="font-family:宋体">用来指定最后数组的大小</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:seagreen; font-family:Consolas; font-size:9pt"><strong>char</strong><span style="color:black"> DataDirectoryName[][50] = { <span style="color:blue">"EXPORT Directory"<span style="color:black">,<span style="color:blue">"IMPORT Directory"<span style="color:black">,<span style="color:blue">"RESOURCE Directory"<span style="color:black">,<span style="color:blue">"EXCEPTION Directory"<span style="color:black">,<span style="color:blue">"SECURITY Directory"<span style="color:black">,<span style="color:blue">"BASERELOC Directory"<span style="color:black">,  <span style="color:#5c5c5c">
																		</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:blue">"DEBUG Directory"<span style="color:black">,<span style="color:blue">"COPYRIGHT Directory"<span style="color:black">,<span style="color:blue">"GLOBALPTR Directory"<span style="color:black">,<span style="color:blue">"TLS Directory"<span style="color:black">,<span style="color:blue">"LOAD_CONFIG Directory"<span style="color:black">,<span style="color:blue">"BOUND_IMPORT Directory"<span style="color:black">,<span style="color:blue">"IAT Directory"<span style="color:black">,<span style="color:blue">"DELAY_IMPORT Directory"<span style="color:black">,  <span style="color:#5c5c5c">
																					</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:blue">"COM_DESCRIPTOR Directory"<span style="color:black">,<span style="color:blue">"Reserved Directory"<span style="color:black"> };  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>for</strong><span style="color:black"> (<span style="color:seagreen"><strong>int</strong><span style="color:black"> i = 0; i &lt; pNtHeader-&gt;OptionalHeader.NumberOfRvaAndSizes; i++) {  <span style="color:#5c5c5c">
								</span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    printf(<span style="color:blue">"%s : 0x%08X    0x%08X\n"<span style="color:black">, DataDirectoryName[i], pNtHeader-&gt;OptionalHeader.DataDirectory[i].VirtualAddress,pNtHeader-&gt;OptionalHeader.DataDirectory[i].Size);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">}  <span style="color:#5c5c5c">
					</span></span></div></li></ol><p>
     </p><p>
     </p><p>节区表：
</p><p>
     </p><p><img src="https://img2020.cnblogs.com/blog/1858293/202007/1858293-20200723184249736-1321279432.png" alt=""/>
</p><p>
     </p><ol><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"\n===================================PE SECTION HEADER====================================\n\n"<span style="color:black">);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:#008200; font-family:Consolas; font-size:9pt">//PIMAGE_SECTION_HEADER pSectionHeader = (PIMAGE_SECTION_HEADER)IMAGE_FIRST_SECTION(pNtHeader);<span style="color:black">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">PIMAGE_SECTION_HEADER pSectionHeader = (PIMAGE_SECTION_HEADER)((<span style="color:seagreen"><strong>DWORD</strong><span style="color:black">)pNtHeader + <span style="color:#006699"><strong>sizeof</strong><span style="color:black">(IMAGE_NT_HEADERS));  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>for</strong><span style="color:black"> (<span style="color:seagreen"><strong>int</strong><span style="color:black"> i = 0; i &lt; pNtHeader-&gt;FileHeader.NumberOfSections; i++) {  <span style="color:#5c5c5c">
								</span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    printf(<span style="color:blue">"--------------stction %d--------------\n\n"<span style="color:black">,i+1);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:#006699"><strong>for</strong><span style="color:black"> (<span style="color:seagreen"><strong>int</strong><span style="color:black"> j = 0; j &lt; IMAGE_SIZEOF_SHORT_NAME; j++) {  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">        printf(<span style="color:blue">"%c"<span style="color:black">, pSectionHeader-&gt;Name[j]);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">    }<span style="color:#008200">//name</span></span><span style="font-family:宋体">的名称可能和实际作用没什么联系</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    printf(<span style="color:blue">"      0x"<span style="color:black">);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:#006699"><strong>for</strong><span style="color:black"> (<span style="color:seagreen"><strong>int</strong><span style="color:black"> j = 0; j &lt; IMAGE_SIZEOF_SHORT_NAME; j++) {  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">        printf(<span style="color:blue">"%X"<span style="color:black">, pSectionHeader-&gt;Name[j]);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    }  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">    printf(<span style="color:blue">"\nVirtualSize : 0x%04X"<span style="color:black">, pSectionHeader-&gt;Misc.VirtualSize);                 <span style="color:#008200">//</span></span></span></span><span style="font-family:宋体">内存中节区所占大小</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">    printf(<span style="color:blue">"\nVirtualAddress : 0x%08X"<span style="color:black">, pSectionHeader-&gt;VirtualAddress);                <span style="color:#008200">//</span></span></span></span><span style="font-family:宋体">内存中节区起始地址</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">    printf(<span style="color:blue">"\nSizeOfRawData : 0x%08X"<span style="color:black">, pSectionHeader-&gt;SizeOfRawData);                  <span style="color:#008200">//</span></span></span></span><span style="font-family:宋体">磁盘文件节区所占大小</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-size:9pt"><span style="font-family:Consolas">    printf(<span style="color:blue">"\nPointerToRawData : 0x%08X"<span style="color:black">, pSectionHeader-&gt;PointerToRawData);            <span style="color:#008200">//</span></span></span></span><span style="font-family:宋体">磁盘文件中节区起始位置</span><span style="font-family:Consolas">  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    printf(<span style="color:blue">"\nPointerToRelocations : 0x%08X"<span style="color:black">, pSectionHeader-&gt;PointerToRelocations);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    printf(<span style="color:blue">"\nPointerToLinenumbers : 0x%08X"<span style="color:black">, pSectionHeader-&gt;PointerToLinenumbers);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    printf(<span style="color:blue">"\nNumberOfRelocations : 0x%04X"<span style="color:black">, pSectionHeader-&gt;NumberOfRelocations);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    printf(<span style="color:blue">"\nNumberOfLinenumbers : 0x%04X"<span style="color:black">, pSectionHeader-&gt;NumberOfLinenumbers);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    printf(<span style="color:blue">"\nCharacteristics : 0x%08X"<span style="color:black">, pSectionHeader-&gt;Characteristics);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    pSectionHeader++;  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    printf(<span style="color:blue">"\n\n"<span style="color:black">);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">}  <span style="color:#5c5c5c">
					</span></span></div></li></ol><p>
     </p><p>
     </p><p>
     </p><p>输入表：
</p><p><img src="https://img2020.cnblogs.com/blog/1858293/202007/1858293-20200723184250338-141544704.png" alt=""/>
</p><p>
     </p><ol><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"\n===================================PE IMPORT====================================\n"<span style="color:black">);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:seagreen; font-family:Consolas; font-size:9pt"><strong>DWORD</strong><span style="color:black"> pImportOffset = RVA_to_RAW(pNtHeader,pNtHeader-&gt;OptionalHeader.DataDirectory[1].VirtualAddress);  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">PIMAGE_IMPORT_DESCRIPTOR pImport = (PIMAGE_IMPORT_DESCRIPTOR)((<span style="color:seagreen"><strong>DWORD</strong><span style="color:black">)pbFile + pImportOffset);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>while</strong><span style="color:black"> (1) {  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:#006699"><strong>if</strong><span style="color:black"> (pImport-&gt;FirstThunk == 0 &amp;&amp; pImport-&gt;ForwarderChain == 0 &amp;&amp; pImport-&gt;Name == 0 &amp;&amp; pImport-&gt;OriginalFirstThunk == 0 &amp;&amp; pImport-&gt;TimeDateStamp == 0) {  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">        <span style="color:#006699"><strong>break</strong><span style="color:black">;  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    }  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:seagreen"><strong>DWORD</strong><span style="color:black"> dwINT =  (<span style="color:seagreen"><strong>DWORD</strong><span style="color:black">)pbFile + RVA_to_RAW(pNtHeader, pImport-&gt;OriginalFirstThunk);  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:seagreen"><strong>DWORD</strong><span style="color:black"> dwTimeDateStamp = (<span style="color:seagreen"><strong>DWORD</strong><span style="color:black">)pbFile + RVA_to_RAW(pNtHeader, pImport-&gt;TimeDateStamp);  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:seagreen"><strong>DWORD</strong><span style="color:black"> dwForwarderChain = (<span style="color:seagreen"><strong>DWORD</strong><span style="color:black">)pbFile + RVA_to_RAW(pNtHeader, pImport-&gt;ForwarderChain);  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:seagreen"><strong>DWORD</strong><span style="color:black"> dwName = (<span style="color:seagreen"><strong>DWORD</strong><span style="color:black">)pbFile + RVA_to_RAW(pNtHeader, pImport-&gt;Name);  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:seagreen"><strong>DWORD</strong><span style="color:black"> dwFirstThunk = (<span style="color:seagreen"><strong>DWORD</strong><span style="color:black">)pbFile + RVA_to_RAW(pNtHeader, pImport-&gt;FirstThunk);  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    printf(<span style="color:blue">"------------------- %s -------------------\n"<span style="color:black">,dwName);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    printf(<span style="color:blue">"TimeDateStamp: 0x%08X\n"<span style="color:black">, pImport-&gt;TimeDateStamp);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    printf(<span style="color:blue">"ForwarderChain: 0x%08X\n"<span style="color:black">, pImport-&gt;ForwarderChain);   <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    printf(<span style="color:blue">"pImport-&gt;FirstThunk: 0x%X\n"<span style="color:black">, pImport-&gt;FirstThunk);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:seagreen"><strong>DWORD</strong><span style="color:black">* ImportByName = (<span style="color:seagreen"><strong>DWORD</strong><span style="color:black">*)dwINT;  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:seagreen"><strong>DWORD</strong><span style="color:black">* pFirstThunk = (<span style="color:seagreen"><strong>DWORD</strong><span style="color:black">*)dwFirstThunk;  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:seagreen"><strong>int</strong><span style="color:black"> i = 0;  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    printf(<span style="color:blue">"\nAddress\t\tHint\tName\n"<span style="color:black">);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:#006699"><strong>while</strong><span style="color:black"> ((ImportByName[i])) {  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">        PIMAGE_IMPORT_BY_NAME pImpoetByName = (PIMAGE_IMPORT_BY_NAME)((<span style="color:seagreen"><strong>DWORD</strong><span style="color:black">)pbFile + RVA_to_RAW(pNtHeader, ImportByName[i]));  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">        printf(<span style="color:blue">"0x%04X\t"<span style="color:black">, pFirstThunk[i]);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">        printf(<span style="color:blue">"0x%04X\t"<span style="color:black">,pImpoetByName-&gt;Hint);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">        printf(<span style="color:blue">"%s\n"<span style="color:black">, pImpoetByName-&gt;Name);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">        i++;  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    }  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">        dwINT++;  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    pImport++;  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">}  <span style="color:#5c5c5c">
					</span></span></div></li></ol><p>
     </p><p>
     </p><p>输出表：
</p><p><img src="https://img2020.cnblogs.com/blog/1858293/202007/1858293-20200723184250795-1696792118.png" alt=""/>
</p><p>
     </p><ol><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"\n===================================PE EXPORT====================================\n"<span style="color:black">);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">PIMAGE_EXPORT_DIRECTORY pExport = (PIMAGE_EXPORT_DIRECTORY)((<span style="color:seagreen"><strong>DWORD</strong><span style="color:black">)pbFile + RVA_to_RAW(pNtHeader, pNtHeader-&gt;OptionalHeader.DataDirectory[0].VirtualAddress));  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"Characteristics : 0x%X\n"<span style="color:black">, pExport-&gt;Characteristics);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"TimeDateStamp : 0x%X\n"<span style="color:black">, pExport-&gt;TimeDateStamp);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"MajorVersion : 0x%X\n"<span style="color:black">, pExport-&gt;MajorVersion);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"MinorVersion : 0x%X\n"<span style="color:black">, pExport-&gt;MinorVersion);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"Base : 0x%X\n"<span style="color:black">, pExport-&gt;Base);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"NumberOfNames: %d\n"<span style="color:black">, pExport-&gt;NumberOfNames);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">printf(<span style="color:blue">"NumberOfFunctions: %d\n"<span style="color:black">, pExport-&gt;NumberOfFunctions);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:seagreen; font-family:Consolas; font-size:9pt"><strong>DWORD</strong><span style="color:black">* AddressOfFunctions = (<span style="color:seagreen"><strong>DWORD</strong><span style="color:black">*)((<span style="color:seagreen"><strong>DWORD</strong><span style="color:black">)pbFile + RVA_to_RAW(pNtHeader, pExport-&gt;AddressOfFunctions));  <span style="color:#5c5c5c">
										</span></span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:seagreen; font-family:Consolas; font-size:9pt"><strong>DWORD</strong><span style="color:black">* AddressOfNameOrdinals = (<span style="color:seagreen"><strong>DWORD</strong><span style="color:black">*)((<span style="color:seagreen"><strong>DWORD</strong><span style="color:black">)pbFile + RVA_to_RAW(pNtHeader, pExport-&gt;AddressOfNameOrdinals));  <span style="color:#5c5c5c">
										</span></span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:seagreen; font-family:Consolas; font-size:9pt"><strong>DWORD</strong><span style="color:black">* AddressOfNames = (<span style="color:seagreen"><strong>DWORD</strong><span style="color:black">*)((<span style="color:seagreen"><strong>DWORD</strong><span style="color:black">)pbFile + RVA_to_RAW(pNtHeader, pExport-&gt;AddressOfNames));  <span style="color:#5c5c5c">
										</span></span></span></span></span></span></span></div></li><li><div style="background: white"><span style="color:seagreen; font-family:Consolas; font-size:9pt"><strong>DWORD</strong><span style="color:black">* Name = (<span style="color:seagreen"><strong>DWORD</strong><span style="color:black">*)((<span style="color:seagreen"><strong>DWORD</strong><span style="color:black">)pbFile + RVA_to_RAW(pNtHeader, pExport-&gt;Name));  <span style="color:#5c5c5c">
										</span></span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:seagreen; font-family:Consolas; font-size:9pt"><strong>WORD</strong><span style="color:black">* pwOrdinals = (<span style="color:seagreen"><strong>WORD</strong><span style="color:black">*)((<span style="color:seagreen"><strong>DWORD</strong><span style="color:black">)pbFile + RVA_to_RAW(pNtHeader, pExport-&gt;AddressOfNameOrdinals));  <span style="color:#5c5c5c">
										</span></span></span></span></span></span></span></div></li><li><div style="background: white">  
     </div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>if</strong><span style="color:black"> (pExport-&gt;NumberOfFunctions == 0) {  <span style="color:#5c5c5c">
						</span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    printf(<span style="color:blue">"\n\t---------- No Export Tabel! ----------\n"<span style="color:black">);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:#006699"><strong>if</strong><span style="color:black"> (NULL != pbFile)  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    {  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">        UnmapViewOfFile(pbFile);  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    }  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8">  
     </div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:#006699"><strong>if</strong><span style="color:black"> (NULL != hMapping)  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    {  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">        CloseHandle(hMapping);  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    }  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white">  
     </div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:#006699"><strong>if</strong><span style="color:black"> (INVALID_HANDLE_VALUE != hFile)  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    {  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">        CloseHandle(hFile);  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    }  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: #f8f8f8">  
     </div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:#006699"><strong>return</strong><span style="color:black"> 0;  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">}  <span style="color:#5c5c5c">
					</span></span></div></li><li><div style="background: white">  
     </div></li><li><div style="background: #f8f8f8"><span style="color:#006699; font-family:Consolas; font-size:9pt"><strong>for</strong><span style="color:black"> (<span style="color:seagreen"><strong>int</strong><span style="color:black"> i = 0; i &lt; pExport-&gt;NumberOfNames; i++) {  <span style="color:#5c5c5c">
								</span></span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:seagreen"><strong>DWORD</strong><span style="color:black"> dwName = (<span style="color:seagreen"><strong>DWORD</strong><span style="color:black">)pbFile + RVA_to_RAW(pNtHeader, AddressOfNames[i]);  <span style="color:#5c5c5c">
									</span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">    <span style="color:seagreen"><strong>DWORD</strong><span style="color:black"> VA = pNtHeader-&gt;OptionalHeader.ImageBase + AddressOfFunctions[i];  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: white"><span style="color:black; font-family:Consolas; font-size:9pt">    printf(<span style="color:blue">"Ordinals: %d\tName: %-30s\tRVA: 0x%08X\tVA: 0x%08X\n"<span style="color:black">, pwOrdinals[i], dwName, AddressOfFunctions[i], VA);  <span style="color:#5c5c5c">
							</span></span></span></span></div></li><li><div style="background: #f8f8f8"><span style="color:black; font-family:Consolas; font-size:9pt">}  <span style="color:#5c5c5c">
					</span></span></div></li></ol><p>
     </p><p>在输入输出表这里遇到了新的问题：在知晓如何把RVA转化成RAW之后，要再次以新的RAW和起始地址找新的结构，这个时候利用了指针指向把数据输出，我一直输出的是指针存放的地址，所以非常难受。
</p><p>
     </p><p>整个代码已经上传至github和gitee：
</p><p>Github：https://github.com/DorinXL/Easy_PEInfo
</p><p>Gitee： https://gitee.com/dorinxl/Easy_PEInfo</p>
</body>
</html>